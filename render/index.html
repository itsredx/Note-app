<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Note App</title>
    <!-- ADD SIMPLEBAR CSS -->
    <link rel="stylesheet" href="./js/scroll-bar/simplebar.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

                <link id="base-stylesheet" type="text/css" rel="stylesheet" href="styles.css">

                <style id="theme-styles">:root {
    --md-sys-color-primary: #D0BCFF;
    --md-sys-color-on-primary: #381E72;
    --md-sys-color-primary-container: #4F378B;
    --md-sys-color-on-primary-container: #EADDFF;
    --md-sys-color-secondary: #CCC2DC;
    --md-sys-color-on-secondary: #332D41;
    --md-sys-color-secondary-container: #4A4458;
    --md-sys-color-on-secondary-container: #E8DEF8;
    --md-sys-color-tertiary: #EFB8C8;
    --md-sys-color-on-tertiary: #492532;
    --md-sys-color-tertiary-container: #633B48;
    --md-sys-color-on-tertiary-container: #FFD8E4;
    --md-sys-color-error: #F2B8B5;
    --md-sys-color-on-error: #601410;
    --md-sys-color-error-container: #8C1D18;
    --md-sys-color-on-error-container: #F9DEDC;
    --md-sys-color-background: #2c2c2c;
    --md-sys-color-on-background: #d3d3d3;
    --md-sys-color-surface: #2c2c2c;
    --md-sys-color-on-surface: #d3d3d3;
    --md-sys-color-surface-variant: #49454F;
    --md-sys-color-on-surface-variant: #CAC4D0;
    --md-sys-color-outline: #938F99;
    --md-sys-color-outline-variant: #49454F;
    --md-sys-color-shadow: #000000;
    --md-sys-color-scrim: #000000;
    --md-sys-color-inverse-surface: #E6E1E5;
    --md-sys-color-inverse-on-surface: #313033;
    --md-sys-color-inverse-primary: #6750A4;
    --primary: var(--md-sys-color-primary);
    --background: var(--md-sys-color-background);
    --surface: var(--md-sys-color-surface);
    --dynamic-c4ad9ffc: #2c2c2c;
    --dynamic-aab20997: #d3d3d3;
    --dynamic-e0ed6f04: #4c4c4c;
    --dynamic-eb6844e8: #383838;
    --dynamic-64326462: rgba(211, 211, 211, 0.5);
    --dynamic-fcbf1ce1: #333030;
    --dynamic-28c5bc9f: #121212;
    --dynamic-87fb2e43: lightgrey;
    --dynamic-68071b82: #EDEDED;
    --dynamic-2fedc7b0: #9E9E9E;
    --dynamic-c3a58620: #5a5a5a;
}</style>

                <style id="dynamic-styles">
.shared-container-0 { box-sizing: border-box; width: 100vw; height: 100vh; }
.shared-stack-0 { position: relative; display: grid; width: fit-content; height: fit-content; justify-items: start; align-items: start; direction: ltr; overflow: hidden; }
.shared-stack-0 > * { grid-area: 1 / 1; }
.shared-row-0 { display: flex; flex-direction: row; justify-content: flex-start; align-items: center; width: 100%; direction: ltr; }

.shared-container-5 { box-sizing: border-box; background: var(--dynamic-c4ad9ffc); border-width: 1px; border-style: solid; border-color: var(--dynamic-c3a58620); background: var(--md-sys-color-surface); padding: 24px 10px; width: 80px; height: 100vh; }
.shared-column-1 { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; height: 100%; direction: ltr; }

.shared-container-4 { box-sizing: border-box; padding: 0.0px 0.0px 20px; }

            .shared-text-3 {
                margin: 0; /* Reset default paragraph margin */
                padding: 0;
                color: var(--md-sys-color-on-surface); font-size: 16px; font-weight: bold;
                
                
            }
            
.shared-iconbutton-0 { display: inline-flex; align-items: center; justify-content: center; padding: 8px; margin: 0; border: none; background-color: var(--dynamic-e0ed6f04); color: var(--dynamic-aab20997); cursor: pointer; outline: none; pointer-events: auto; border-radius: 50%; overflow: hidden; position: relative; box-sizing: border-box; transition: background-color 0.15s linear; -webkit-appearance: none; appearance: none; width: calc(24px + 16px); height: calc(24px + 16px); }

            .shared-iconbutton-0 > i, .shared-iconbutton-0 > img, .shared-iconbutton-0 > svg, .shared-iconbutton-0 > * {
                font-size: 24px;
                width: 24px;
                height: 24px;
                display: block;
                object-fit: contain;
            }
.shared-iconbutton-0:hover { background-color: var(--dynamic-eb6844e8); }
.shared-iconbutton-0:active { background-color: rgba(0, 0, 0, 0.12); }
.shared-iconbutton-0.active { background-color: rgba(0, 0, 0, 0.12); }
.shared-iconbutton-0.disabled { color: rgba(0, 0, 0, 0.38); background-color: transparent; cursor: default; pointer-events: none; }

                .material-icon-0 {
                    position: relative;
                    font-family: 'Material Symbols Rounded';
                    font-weight: normal;
                    font-style: normal;
                    font-size: 24px;
                    
                    line-height: 1;
                    letter-spacing: normal;
                    text-transform: none;
                    z-index: 100;
                    display: inline-block;
                    white-space: nowrap;
                    word-wrap: normal;
                    direction: ltr;
                    -webkit-font-smoothing: antialiased;
                    text-rendering: optimizeLegibility;
                    -moz-osx-font-smoothing: grayscale;
                    font-feature-settings: 'liga';
                    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
                }
            

.shared-container-7 { box-sizing: border-box; background: var(--md-sys-color-surface); padding: 24px 40px 32px; width: calc(100vw - 80px); height: 100vh; }
.shared-column-2 { display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; height: 100%; direction: ltr; }
.shared-row-1 { display: flex; flex-direction: row; justify-content: flex-end; align-items: flex-start; width: 100%; direction: ltr; }

            .shared-text-4 {
                margin: 0; /* Reset default paragraph margin */
                padding: 0;
                color: var(--md-sys-color-on-surface); font-size: 32px; font-weight: bold;
                
                
            }
            

.shared-container-6 { box-sizing: border-box; height: 85vh; }
.shared-gridview-0 { padding: (0, 0, 0, 0); flex-grow: 1; flex-basis: 0; width: 100%; height: 100%; min-height: 0; min-width: 0; overflow-y: auto; display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px 20px;box-sizing: border-box; }
.shared-gridview-0 > * { aspect-ratio: 1.0; overflow: hidden;min-width: 0; min-height: 0; }
.shared-stack-1 { position: relative; display: grid; width: fit-content; height: fit-content; justify-items: start; align-items: start; direction: ltr;  }
.shared-stack-1 > * { grid-area: 1 / 1; }

.shared-container-9 { box-sizing: border-box; background: #FFAB91; padding: 12px; width: 231px; height: 231px; }
.shared-column-0 { display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; height: 100%; direction: ltr; }

.shared-container-8 { box-sizing: border-box; width: 110px; height: 30px; }

            .shared-text-5 {
                margin: 0; /* Reset default paragraph margin */
                padding: 0;
                font-family: ubuntu; font-size: 24px;
                
                
            }
            

            .shared-text-6 {
                margin: 0; /* Reset default paragraph margin */
                padding: 0;
                font-family: ubuntu; font-size: 16px;
                
                
            }
            

.shared-container-10 { box-sizing: border-box; }
.shared-row-4 { display: flex; flex-direction: row; justify-content: flex-end; align-items: center; width: 100%; direction: ltr; }

                .material-icon-2 {
                    position: relative;
                    font-family: 'Material Symbols Outlined';
                    font-weight: normal;
                    font-style: normal;
                    font-size: 24px;
                    
                    line-height: 1;
                    letter-spacing: normal;
                    text-transform: none;
                    z-index: 100;
                    display: inline-block;
                    white-space: nowrap;
                    word-wrap: normal;
                    direction: ltr;
                    -webkit-font-smoothing: antialiased;
                    text-rendering: optimizeLegibility;
                    -moz-osx-font-smoothing: grayscale;
                    font-feature-settings: 'liga';
                    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
                }
            
.shared-row-5 { display: flex; flex-direction: row; justify-content: space-between; align-items: center; width: 100%; direction: ltr; }

.shared-container-11 { box-sizing: border-box; border-radius: 20px; background: var(--dynamic-e0ed6f04); width: 100px; height: 40px; }
.shared-center-0 { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%;  }

            .shared-text-7 {
                margin: 0; /* Reset default paragraph margin */
                padding: 0;
                color: var(--dynamic-aab20997); font-family: ubuntu mono; font-size: 12px;
                
                
            }
            

.shared-container-12 { box-sizing: border-box; background: #CE93D8; padding: 12px; width: 231px; height: 231px; }

.shared-container-13 { box-sizing: border-box; background: #4DD0E1; padding: 12px; width: 231px; height: 231px; }</style>

                
        <script src="qwebchannel.js"></script>
        <script>
            // Suppress inset-area deprecation warnings
            (function() {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    const message = args.join(' ');
                    if (message.includes('inset-area') || 
                        message.includes('position-area') ||
                        message.includes('has been deprecated')) {
                        return; // Suppress these specific warnings
                    }
                    originalWarn.apply(console, args);
                };
            })();
            
            document.addEventListener('DOMContentLoaded', () => {
                new QWebChannel(qt.webChannelTransport, (channel) => {
                    window.pywebview = channel.objects.pywebview;
                    console.log("PyWebChannel connected.");
                });
            });
            function handleClick(name) { if(window.pywebview) window.pywebview.on_pressed_str(name, ()=>{}); }
            function handleClickWithArgs(callback_name, ...args) {
                if (window.pywebview) {
                    console.log("index", args);
                    window.pywebview.on_pressed(callback_name, ...args).then(function(response) {
                        console.log(response);
                    }).catch(function(error) {
                        console.error(error);
                    });
                } else {
                    console.error('pywebview is not defined');
                }
            }
            function handleItemTap(name, index) { if(window.pywebview) window.pywebview.on_item_tap(name, index, ()=>{}); }
            function handleInput(name, value) {
                if(window.pywebview) {
                    window.pywebview.on_input_changed(name, value, ()=>{});
                }
            }
        </script>
        

                

            </head>
<body>
    <div id="root-container"><div id="fw_id_1" class=""><div id="fw_id_2" class="shared-container-0"><div id="fw_id_3" class=""><div id="fw_id_4" class=""><div id="fw_id_5" class="shared-stack-0"><div id="fw_id_6" class="shared-row-0"><div id="fw_id_7" class="shared-container-5"><div id="fw_id_8" class="shared-column-1"><div id="fw_id_9" class="shared-container-4"><p id="fw_id_10" class="shared-text-3" style="color: var(--md-sys-color-on-surface); font-size: 16; font-weight: bold">Note</p></div><div id="fw_id_11" class="shared-container-4"><button id="fw_id_12" class="shared-iconbutton-0" onclick="handleClick('toggle_color_picker')"><i id="fw_id_13" class="material-icon-0">add_circle_outline</i></button></div></div></div><div id="fw_id_14" class="shared-container-7"><div id="fw_id_15" class="shared-column-2"><div id="fw_id_16" class=""><div id="fw_id_17" class="shared-row-1"><button id="fw_id_18" class="shared-iconbutton-0" onclick="handleClick('toggle_theme')" title="Light Mode"><i id="fw_id_19" class="material-icon-0">light_mode</i></button><div id="fw_id_20" class="" style="width: 12px"></div><button id="fw_id_21" class="shared-iconbutton-0" onclick="handleClick('&lt;lambda&gt;')" title="User Account &amp; Settings"><i id="fw_id_22" class="material-icon-0">account_circle</i></button></div></div><div id="fw_id_23" class="" style="height: 24px"></div><p id="fw_id_24" class="shared-text-4" style="color: var(--md-sys-color-on-surface); font-size: 32; font-weight: bold">Dashboard</p><div id="fw_id_25" class="" style="height: 24px"></div><div id="fw_id_26" class="shared-container-6"><div id="fw_id_27" class="shared-gridview-0"><div id="fw_id_28" class=""><div id="fw_id_29" class="shared-stack-1"><div id="fw_id_30" class="" style="width: 231px; height: 231px"><div id="fw_id_31" class="shared-container-9"><div id="fw_id_32" class="shared-column-0"><div id="fw_id_33" class="shared-container-8"><p id="fw_id_34" class="shared-text-5" style="font-family: ubuntu; font-size: 24">Design</p></div><div id="fw_id_35" class="" style="height: 24px"></div><p id="fw_id_36" class="shared-text-6" style="font-family: ubuntu; font-size: 16">Make the design looks okay...</p></div></div></div><div id="fw_id_37" class="" style="position: absolute; height: 231px; width: 231px; bottom: ; top: ; right: ; left: "><div id="fw_id_38" class="shared-container-10"><div id="fw_id_39" class="shared-row-4"><button id="fw_id_40" class="shared-iconbutton-0" onclick="handleClick('delete_note')"><i id="fw_id_41" class="material-icon-2">delete</i></button><div id="fw_id_42" class="" style="width: 8px"></div><button id="fw_id_43" class="shared-iconbutton-0" onclick="handleClick('chat_note')"><i id="fw_id_44" class="material-icon-2">chat</i></button></div></div></div><div id="fw_id_45" class="" style="position: absolute; height: 231px; width: 231px; bottom: ; top: 189px; right: ; left: "><div id="fw_id_46" class="shared-container-10"><div id="fw_id_47" class="shared-row-5"><div id="fw_id_48" class="shared-container-11"><div id="fw_id_49" class="shared-center-0"><p id="fw_id_50" class="shared-text-7" style="color: var(--dynamic-aab20997); font-family: ubuntu mono; font-size: 12">20 Dec</p></div></div><button id="fw_id_51" class="shared-iconbutton-0" onclick="handleClick('open_note')"><i id="fw_id_52" class="material-icon-2">open_in_new</i></button></div></div></div></div></div><div id="fw_id_53" class=""><div id="fw_id_54" class="shared-stack-1"><div id="fw_id_55" class="" style="width: 231px; height: 231px"><div id="fw_id_56" class="shared-container-12"><div id="fw_id_57" class="shared-column-0"><div id="fw_id_58" class="shared-container-8"><p id="fw_id_59" class="shared-text-5" style="font-family: ubuntu; font-size: 24">Project</p></div><div id="fw_id_60" class="" style="height: 24px"></div><p id="fw_id_61" class="shared-text-6" style="font-family: ubuntu; font-size: 16">Finish the project documentation</p></div></div></div><div id="fw_id_62" class="" style="position: absolute; height: 231px; width: 231px; bottom: ; top: ; right: ; left: "><div id="fw_id_63" class="shared-container-10"><div id="fw_id_64" class="shared-row-4"><button id="fw_id_65" class="shared-iconbutton-0" onclick="handleClick('delete_note')"><i id="fw_id_66" class="material-icon-2">delete</i></button><div id="fw_id_67" class="" style="width: 8px"></div><button id="fw_id_68" class="shared-iconbutton-0" onclick="handleClick('chat_note')"><i id="fw_id_69" class="material-icon-2">chat</i></button></div></div></div><div id="fw_id_70" class="" style="position: absolute; height: 231px; width: 231px; bottom: ; top: 189px; right: ; left: "><div id="fw_id_71" class="shared-container-10"><div id="fw_id_72" class="shared-row-5"><div id="fw_id_73" class="shared-container-11"><div id="fw_id_74" class="shared-center-0"><p id="fw_id_75" class="shared-text-7" style="color: var(--dynamic-aab20997); font-family: ubuntu mono; font-size: 12">21 Dec</p></div></div><button id="fw_id_76" class="shared-iconbutton-0" onclick="handleClick('open_note')"><i id="fw_id_77" class="material-icon-2">open_in_new</i></button></div></div></div></div></div><div id="fw_id_78" class=""><div id="fw_id_79" class="shared-stack-1"><div id="fw_id_80" class="" style="width: 231px; height: 231px"><div id="fw_id_81" class="shared-container-13"><div id="fw_id_82" class="shared-column-0"><div id="fw_id_83" class="shared-container-8"><p id="fw_id_84" class="shared-text-5" style="font-family: ubuntu; font-size: 24">Meeting</p></div><div id="fw_id_85" class="" style="height: 24px"></div><p id="fw_id_86" class="shared-text-6" style="font-family: ubuntu; font-size: 16">Sync with the team at 10am</p></div></div></div><div id="fw_id_87" class="" style="position: absolute; height: 231px; width: 231px; bottom: ; top: ; right: ; left: "><div id="fw_id_88" class="shared-container-10"><div id="fw_id_89" class="shared-row-4"><button id="fw_id_90" class="shared-iconbutton-0" onclick="handleClick('delete_note')"><i id="fw_id_91" class="material-icon-2">delete</i></button><div id="fw_id_92" class="" style="width: 8px"></div><button id="fw_id_93" class="shared-iconbutton-0" onclick="handleClick('chat_note')"><i id="fw_id_94" class="material-icon-2">chat</i></button></div></div></div><div id="fw_id_95" class="" style="position: absolute; height: 231px; width: 231px; bottom: ; top: 189px; right: ; left: "><div id="fw_id_96" class="shared-container-10"><div id="fw_id_97" class="shared-row-5"><div id="fw_id_98" class="shared-container-11"><div id="fw_id_99" class="shared-center-0"><p id="fw_id_100" class="shared-text-7" style="color: var(--dynamic-aab20997); font-family: ubuntu mono; font-size: 12">22 Dec</p></div></div><button id="fw_id_101" class="shared-iconbutton-0" onclick="handleClick('open_note')"><i id="fw_id_102" class="material-icon-2">open_in_new</i></button></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>
    <div id="overlay-container"></div>

    <!-- ADD SIMPLEBAR JS -->
    <script src="./js/scroll-bar/simplebar.min.js"></script>
    <script src="./js/pythra_bridge.js"></script>
    <!-- ADD THE NEW SLIDER JS ENGINE -->
    
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                window._pythra_instances = window._pythra_instances || {};
                try {
                    // First, DEFINE all our JS classes and functions
                    // --- Injected from pathGenerator.js ---
try {
                        
// js/pathGenerator.js

// --- Vector Math Helper Functions ---
const vec = (p1, p2) => ({ x: p2.x - p1.x, y: p2.y - p1.y });
const magnitude = (v) => Math.sqrt(v.x ** 2 + v.y ** 2);
const dot = (v1, v2) => v1.x * v2.x + v1.y * v2.y;
const cross = (v1, v2) => v1.x * v2.y - v1.y * v2.x;
const round = (val) => Math.round(val * 100) / 100; // Round to 2 decimal places

function generateRoundedPath(points, radius) {
    const numPoints = points.length;
    const cornerData = [];

    console.log(`>>>>>> Generator Initiated <<<<<<`)

    for (let i = 0; i < numPoints; i++) {
        const p_prev = points[(i + numPoints - 1) % numPoints];
        const p_curr = points[i];
        const p_next = points[(i + 1) % numPoints];

        const v1 = vec(p_curr, p_prev);
        const v2 = vec(p_curr, p_next);
        const v1_mag = magnitude(v1);
        const v2_mag = magnitude(v2);

        if (v1_mag === 0 || v2_mag === 0) {
            cornerData.push({ t1: p_curr, t2: p_curr, radius: 0 });
            continue;
        }

        const angle = Math.acos(Math.max(-1, Math.min(1, dot(v1, v2) / (v1_mag * v2_mag))));
        let tangentDist = radius / Math.tan(angle / 2);
        tangentDist = Math.min(tangentDist, v1_mag / 2, v2_mag / 2);
        const clampedRadius = Math.abs(tangentDist * Math.tan(angle / 2));

        const t1 = { x: p_curr.x + (v1.x / v1_mag) * tangentDist, y: p_curr.y + (v1.y / v1_mag) * tangentDist };
        const t2 = { x: p_curr.x + (v2.x / v2_mag) * tangentDist, y: p_curr.y + (v2.y / v2_mag) * tangentDist };

        const sweepFlag = cross(v1, v2) < 0 ? 1 : 0;

        cornerData.push({ t1, t2, radius: clampedRadius, sweepFlag });
    }

    const pathCommands = [];
    pathCommands.push(`M ${round(cornerData[numPoints - 1].t2.x)} ${round(cornerData[numPoints - 1].t2.y)}`);
    for (let i = 0; i < numPoints; i++) {
        const corner = cornerData[i];
        pathCommands.push(`L ${round(corner.t1.x)} ${round(corner.t1.y)}`);
        pathCommands.push(`A ${round(corner.radius)} ${round(corner.radius)} 0 0 ${corner.sweepFlag} ${round(corner.t2.x)} ${round(corner.t2.y)}`);
    }
    pathCommands.push('Z');
    console.log(pathCommands.join(' '));
    return pathCommands.join(' ');
}


                        // Make common names available on window if defined

                        if (typeof ResponsiveClipPath !== 'undefined') window.ResponsiveClipPath = ResponsiveClipPath;

                        if (typeof PythraSlider !== 'undefined') window.PythraSlider = PythraSlider;

                        if (typeof PythraDropdown !== 'undefined') window.PythraDropdown = PythraDropdown;

                        if (typeof PythraGestureDetector !== 'undefined') window.PythraGestureDetector = PythraGestureDetector;

                        if (typeof PythraGradientClipPath !== 'undefined') window.PythraGradientClipPath = PythraGradientClipPath;

                        if (typeof PythraVirtualList !== 'undefined') window.PythraVirtualList = PythraVirtualList;

                        if (typeof generateRoundedPath !== 'undefined') window.generateRoundedPath = generateRoundedPath;

                        if (typeof scalePathAbsoluteMLA !== 'undefined') window.scalePathAbsoluteMLA = scalePathAbsoluteMLA;

                    } catch (e) { console.error('Error loading pathGenerator.js:', e); }

// --- Injected from clipPathUtils.js ---
try {
                        
// clipPathUtils.js

/**
 * Parse an SVG path string containing absolute commands (M, L, A, H, V, Z),
 * and scale coordinates from reference dimensions to target dimensions.
 * 
 * @param {string} pathStr - Original SVG path string (absolute commands only)
 * @param {number} refW - reference width
 * @param {number} refH - reference height
 * @param {number} targetW - actual element width
 * @param {number} targetH - actual element height
 * @param {Object} [options] - optional settings:
 *    - {boolean} uniformArc
 *    - {number} decimalPlaces
 *    - {boolean} percentOutput
 * @returns {string} - scaled path string
 */
// clipPathUtils.js

function scalePathAbsoluteMLA(pathStr, refW, refH, targetW, targetH, options = {}) {
  const rw = targetW / refW;
  const rh = targetH / refH;
  const uniformArc = !!options.uniformArc;
  const decimalPlaces = typeof options.decimalPlaces === 'number' ? options.decimalPlaces : null;
  const rScale = uniformArc ? Math.min(rw, rh) : null;

  const fmt = (num) => {
    return decimalPlaces !== null
      ? Number(num.toFixed(decimalPlaces)).toString()
      : Number(num).toString();
  };

  // Normalize the string
  const s = pathStr
    .replace(/,/g, ' ')
    .replace(/([0-9])-/g, '$1 -')
    .replace(/\s+/g, ' ')
    .trim();

  const tokenRegex = /([MLAZHV])|(-?\d*\.?\d+(?:e[-+]?\d+)?)/gi;
  const tokens = [];
  let match;
  while ((match = tokenRegex.exec(s)) !== null) {
    tokens.push(match[1] || match[2]);
  }

  const out = [];
  let i = 0;
  while (i < tokens.length) {
    const cmd = tokens[i++];
    out.push(cmd);

    switch (cmd) {
      case 'M':
      case 'L':
        while (i + 1 < tokens.length && !/^[MLAZHV]$/.test(tokens[i])) {
          const x = parseFloat(tokens[i++]) * rw;
          const y = parseFloat(tokens[i++]) * rh;
          out.push(fmt(x), fmt(y));
        }
        break;

      case 'A':
        while (i + 6 < tokens.length && !/^[MLAZHV]$/.test(tokens[i])) {
          const rx = parseFloat(tokens[i++]);
          const ry = parseFloat(tokens[i++]);
          const rot = tokens[i++];
          const laf = tokens[i++];
          const sf = tokens[i++];
          const x = parseFloat(tokens[i++]);
          const y = parseFloat(tokens[i++]);

          out.push(
            fmt(uniformArc ? rx * rScale : rx * rw),
            fmt(uniformArc ? ry * rScale : ry * rh),
            rot,
            laf,
            sf,
            fmt(x * rw),
            fmt(y * rh)
          );
        }
        break;

      case 'H':
        while (i < tokens.length && !/^[MLAZHV]$/.test(tokens[i])) {
          const x = parseFloat(tokens[i++]) * rw;
          out.push(fmt(x));
        }
        break;

      case 'V':
        while (i < tokens.length && !/^[MLAZHV]$/.test(tokens[i])) {
          const y = parseFloat(tokens[i++]) * rh;
          out.push(fmt(y));
        }
        break;

      case 'Z':
        // No coordinates to scale
        break;

      default:
        console.warn('Unsupported or unexpected token:', cmd);
    }
  }

  return out.join(' ');
}

class ResponsiveClipPath {
  constructor(target, originalPath, refW, refH, options = {}) {
    this.elements = [];
    this.orig = originalPath.trim();
    this.refW = refW;
    this.refH = refH;
    this.options = options;
    this.currentPath = "";  // â¬…ï¸ Store last computed path string
    this.update = this.update.bind(this);
    this.roList = [];

    if (typeof target === 'string') {
      let selector = target;
      if (!selector.startsWith('#') && !selector.startsWith('.')) {
        const byId = document.getElementById(selector);
        selector = byId ? `#${selector}` : `.${selector}`;
      }
      const nodeList = document.querySelectorAll(selector);
      if (nodeList.length === 0) {
        console.warn(`ResponsiveClipPath: no elements found for selector "${selector}"`);
      }
      nodeList.forEach(el => this.elements.push(el));
    } else if (target instanceof HTMLElement) {
      this.elements.push(target);
    } else {
      console.warn('ResponsiveClipPath: invalid target', target);
    }

    this.elements.forEach(el => this.initElement(el));
  }

  initElement(el) {
    this.applyClip(el);
    if (window.ResizeObserver) {
      const ro = new ResizeObserver(() => this.applyClip(el));
      ro.observe(el);
      this.roList.push({ el, ro });
    } else {
      window.addEventListener('resize', this.update);
    }
  }

  applyClip(el) {
    const rect = el.getBoundingClientRect();
    const newPath = scalePathAbsoluteMLA(
      this.orig,
      this.refW,
      this.refH,
      rect.width,
      rect.height,
      this.options
    );
    this.currentPath = `path("${newPath}")`;  // â¬…ï¸ Save it
    el.style.clipPath = this.currentPath;
    el.style.webkitClipPath = this.currentPath;
  }

  update() {
    this.elements.forEach(el => this.applyClip(el));
  }

  disconnect() {
    this.roList.forEach(({ el, ro }) => ro.unobserve(el));
    this.roList = [];
    window.removeEventListener('resize', this.update);
  }

  // âœ… Your new method
  getResponsivePath() {
    return this.currentPath;
  }
}


                        // Make common names available on window if defined

                        if (typeof ResponsiveClipPath !== 'undefined') window.ResponsiveClipPath = ResponsiveClipPath;

                        if (typeof PythraSlider !== 'undefined') window.PythraSlider = PythraSlider;

                        if (typeof PythraDropdown !== 'undefined') window.PythraDropdown = PythraDropdown;

                        if (typeof PythraGestureDetector !== 'undefined') window.PythraGestureDetector = PythraGestureDetector;

                        if (typeof PythraGradientClipPath !== 'undefined') window.PythraGradientClipPath = PythraGradientClipPath;

                        if (typeof PythraVirtualList !== 'undefined') window.PythraVirtualList = PythraVirtualList;

                        if (typeof generateRoundedPath !== 'undefined') window.generateRoundedPath = generateRoundedPath;

                        if (typeof scalePathAbsoluteMLA !== 'undefined') window.scalePathAbsoluteMLA = scalePathAbsoluteMLA;

                    } catch (e) { console.error('Error loading clipPathUtils.js:', e); }

// --- Injected Plugin 'pythra-markdown-editor': editor.js ---
try {
// PythraMarkdownEditor - A full-featured, themeable, and memory-safe WYSIWYG Editor Engine
class PythraMarkdownEditor {
    constructor(elementOrId, options = {}) {
        if (typeof elementOrId === 'string') {
            this.container = document.getElementById(elementOrId);
            if (!this.container) {
                console.error(`PythraMarkdownEditor Error: Container with ID '${elementOrId}' not found.`);
                return;
            }
        } else {
            this.container = elementOrId;
        }

        this.options = options;
        this.options.showControls = this.options.showControls ?? true;
        this.options.showGrid = this.options.showGrid ?? false;

        this.editorElement = null;
        this._changeTimer = null;
        this._changeHandler = null;
        this._feedbackHandler = null;

        if (this.container) {
            this.container.style.width = this.options.width || (this.options.style?.defaults?.width || '100%');
            this.container.style.height = this.options.height || (this.options.style?.defaults?.height || 'auto');
        }

        if (!window._pythraEditorStylesInjected) {
            this.injectStyles();
            window._pythraEditorStylesInjected = true;
        }

        this._applyStyles();

        // --- NEW: Attach the global selection listener if it doesn't exist ---
        if (!window._pythraSelectionListenerAttached) {
            console.log("Attaching global selection listener for Pythra editors.");

            document.addEventListener('selectionchange', () => {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const currentRange = selection.getRangeAt(0);
                    const allInstances = window._pythra_instances || {};
                    // Check if the current selection is inside ANY known editor instance
                    for (const key in allInstances) {
                        if (allInstances[key] && allInstances[key].editorElement && allInstances[key].editorElement.contains(selection.anchorNode)) {
                            // This is a valid selection inside our editor, save it globally.
                            window._pythraSavedSelection = currentRange;
                            console.log("current range: ", currentRange);
                            return; // Found the active editor
                        }
                    }
                }
            });
            window._pythraSelectionListenerAttached = true;
        }

        this.init();
    }

    _applyStyles() {
        if (!this.options.style || !this.container) return;
        const style = this.options.style;
        const root = this.container;
        const setVar = (name, value) => value != null && root.style.setProperty(name, value);

        if (style.theme) {
            setVar('--pe-accent-color', style.theme.accentColor);
            setVar('--pe-accent-hover', style.theme.accentHover);
            setVar('--pe-border-color', style.theme.borderColor);
            setVar('--pe-border-radius', style.theme.borderRadius);
            setVar('--pe-border-width', style.theme.borderWidth);
            if (style.theme.focusRing) {
                setVar('--pe-focus-ring-color', style.theme.focusRing.color);
                setVar('--pe-focus-ring-width', style.theme.focusRing.width);
            }
        }
        if (style.toolbar) {
            setVar('--pe-toolbar-bg', style.toolbar.backgroundColor);
            setVar('--pe-toolbar-hover', style.toolbar.hoverColor);
            setVar('--pe-toolbar-active', style.toolbar.activeColor);
            setVar('--pe-toolbar-icon', style.toolbar.iconColor);
            setVar('--pe-toolbar-shadow', style.toolbar.shadow);
        }
        if (style.content) {
            setVar('--pe-content-bg', style.content.backgroundColor);
            setVar('--pe-content-text', style.content.textColor);
            setVar('--pe-content-font', style.content.fontFamily);
            setVar('--pe-content-font-size', style.content.fontSize);
            setVar('--pe-content-line-height', style.content.lineHeight);
            setVar('--pe-content-padding', style.content.padding);
            setVar('--pe-content-placeholder', style.content.placeholderColor);
        }
        if (style.grid) {
            setVar('--pe-grid-dot-color', style.grid.dotColor);
            setVar('--pe-grid-dot-size', `${style.grid.dotSize || 1}px`);
            setVar('--pe-grid-dot-spacing', `${style.grid.dotSpacing || 20}px`);
            setVar('--pe-grid-background-color', style.grid.backgroundColor);
        }
    }

    init() {
        let controlPanel = this.container.querySelector('.control-panel');
        let editorEl = this.container.querySelector('[contenteditable="true"]');

        this.container.classList.add('pythra-editor-wrapper');

        if (this.options.showControls) {
            let toggleBtn = this.container.querySelector('.pythra-toggle-button');
            if (!controlPanel) {
                toggleBtn = document.createElement('button');
                toggleBtn.id = `toggleControls_${this.options.instanceId || ''}`;
                toggleBtn.className = 'pythra-toggle-button';
                this.container.prepend(toggleBtn);
                controlPanel = this.createControlPanel();
                toggleBtn.insertAdjacentElement('afterend', controlPanel);
            }
            if (this.options.controlsInitiallyHidden && !controlPanel.classList.contains('hidden')) {
                controlPanel.classList.add('hidden');
            } else if (!this.options.controlsInitiallyHidden && controlPanel.classList.contains('hidden')) {
                controlPanel.classList.remove('hidden');
            }
            if (toggleBtn) {
                const isHidden = controlPanel.classList.contains('hidden');
                toggleBtn.textContent = isHidden ? 'Show Controls' : 'Hide Controls';
                toggleBtn.onclick = () => {
                    const isNowHidden = controlPanel.classList.toggle('hidden');
                    toggleBtn.textContent = isNowHidden ? 'Show Controls' : 'Hide Controls';
                    if (typeof handleInput === 'function' && this.options.onToggleControlsCallback) {
                        handleInput(this.options.onToggleControlsCallback, !isNowHidden);
                    }
                };
            }
        } else if (controlPanel) {
            const toggleBtn = this.container.querySelector('.pythra-toggle-button');
            if (toggleBtn) toggleBtn.remove();
            controlPanel.remove();
        }

        if (!editorEl) {
            editorEl = document.createElement('div');
            editorEl.id = this.options.instanceId ? `editor_${this.options.instanceId}` : 'editor';
            editorEl.contentEditable = true;
            editorEl.className = 'editor-inner-container';
            this.container.appendChild(editorEl);
        }
        this.editorElement = editorEl;

        if (this.options.initialContent != null && this.editorElement.innerHTML !== this.options.initialContent) {
            this.editorElement.innerHTML = this.options.initialContent;
        }

        this.editorElement.classList.toggle('grid-background', this.options.showGrid);
        this._setupChangeHandler();
        this._setupVisualFeedbackHandlers();

        if (this.imageResizer) this.imageResizer.destroy();
        this.imageResizer = new PythraImageResizer(this.editorElement);
    }

    createControlPanel() {
        const panel = document.createElement('div');
        panel.className = 'control-panel';
        const group1 = document.createElement('div');
        group1.className = 'control-group';
        [{ cmd: 'formatBlock', val: 'H1', title: 'Heading 1', label: 'H1' }, { cmd: 'formatBlock', val: 'H2', title: 'Heading 2', label: 'H2' }, { cmd: 'formatBlock', val: 'P', title: 'Paragraph', label: 'P' }, { cmd: 'insertUnorderedList', title: 'Unordered List', label: 'UL' }, { cmd: 'insertOrderedList', title: 'Ordered List', label: 'OL' },].forEach(c => group1.appendChild(this.createButton(c.cmd, c.label, c.title, c.val)));
        panel.appendChild(group1);
        const group2 = document.createElement('div');
        group2.className = 'control-group';
        [{ id: `btn-bold_${this.options.instanceId}`, cmd: 'bold', title: 'Bold', label: '<b>B</b>' }, { id: `btn-italic_${this.options.instanceId}`, cmd: 'italic', title: 'Italic', label: '<i>I</i>' }, { id: `btn-underline_${this.options.instanceId}`, cmd: 'underline', title: 'Underline', label: '<u>U</u>' }, { id: `btn-strikeThrough_${this.options.instanceId}`, cmd: 'strikeThrough', title: 'Strikethrough', label: '<s>S</s>' },].forEach(c => group2.appendChild(this.createButton(c.cmd, c.label, c.title, null, c.id)));
        panel.appendChild(group2);
        const group3 = document.createElement('div');
        group3.className = 'control-group';
        group3.appendChild(this.createColorPicker());
        group3.appendChild(this.createFontSelector());
        panel.appendChild(group3);
        const group4 = document.createElement('div');
        group4.className = 'control-group';
        const insertImageBtn = this.createButton('insertImage', 'ðŸ–¼ï¸', 'Insert Image');
        insertImageBtn.onclick = () => { const url = prompt("Enter the image URL:"); if (url) { this.execCommand('insertImage', url); } };
        group4.appendChild(insertImageBtn);
        panel.appendChild(group4);
        return panel;
    }

    createButton(command, label, title, value = null, id = null) {
        const button = document.createElement('button');
        if (id) button.id = id;
        button.title = title;
        button.innerHTML = label;
        button.onclick = () => this.execCommand(command, value);
        return button;
    }

    createColorPicker() {
        const input = document.createElement('input');
        input.type = 'color';
        input.title = 'Font Color';
        input.oninput = (e) => this.execCommand('foreColor', e.target.value);
        return input;
    }

    createFontSelector() {
        const select = document.createElement('select');
        select.title = 'Font Family';
        select.onchange = (e) => this.execCommand('fontName', e.target.value);
        const fontsToUse = (this.options.fontList && Array.isArray(this.options.fontList) && this.options.fontList.length > 0) ? this.options.fontList : [{ val: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif', label: 'System Default' }, { val: 'Arial, sans-serif', label: 'Arial' }, { val: "'Times New Roman', serif", label: 'Times New Roman' },];
        fontsToUse.forEach(font => select.add(new Option(font.label, font.val)));
        return select;
    }

    _setupChangeHandler() {
        if (!this.editorElement) return;
        this._changeHandler = () => {
            clearTimeout(this._changeTimer);
            this._changeTimer = setTimeout(() => {
                const content = this.editorElement.innerHTML;
                if (typeof handleInput === 'function' && this.options.callback) {
                    handleInput(this.options.callback, content);
                }
            }, 180);
        };
        this.editorElement.addEventListener('input', this._changeHandler);
    }

    _setupVisualFeedbackHandlers() {
        if (!this.editorElement) return;
        this._feedbackHandler = () => {
            this.updateButtonStates();
            this.reportCursorState();
        };
        ['keyup', 'mouseup', 'focus', 'click'].forEach(eventType => {
            this.editorElement.addEventListener(eventType, this._feedbackHandler);
        });
    }

    // --- NEW METHOD ---
    reportCursorState() {
        if (typeof handleInput !== 'function' || !this.options.onStateChangeCallback) {
            return;
        }

        // Gather all the formatting states at the current cursor position
        const state = {
            isBold: document.queryCommandState('bold'),
            isItalic: document.queryCommandState('italic'),
            isUnderline: document.queryCommandState('underline'),
            isStrikeThrough: document.queryCommandState('strikeThrough'),
            isUnorderedList: document.queryCommandState('insertUnorderedList'),
            isOrderedList: document.queryCommandState('insertOrderedList'),

            // queryCommandValue returns the value of the command (e.g., 'Verdana' or 'H1')
            fontName: document.queryCommandValue('fontName'),
            fontColor: document.queryCommandValue('foreColor'), // This will be an RGB string like "rgb(255, 0, 0)"
            blockFormat: document.queryCommandValue('formatBlock'), // e.g., 'h1', 'p'
        };

        // --- NEW: Add selection coordinates ---
        const selection = window.getSelection();
        if (selection.rangeCount > 0 && !selection.isCollapsed) {
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            // Important: These coordinates are relative to the viewport.
            // We might need to adjust them based on the window/screen context in Python,
            // or just pass them as is if the Python UI overlay is also screen-relative (which it often is in these frameworks).
            state.hasSelection = true;
            state.selectionRect = {
                top: rect.top,
                bottom: rect.bottom,
                left: rect.left,
                right: rect.right,
                width: rect.width,
                height: rect.height
            };

            // --- NEW: Update Overlay Position via JS ---
            if (window._pythraOverlay) {
                const overlay = window._pythraOverlay;
                overlay.style.display = 'block';
                // Position above the selection
                // We assume the overlay has position: absolute or fixed
                // Adding scroll offset if needed, though getBoundingClientRect is viewport relative.
                // If the Container is fixed/absolute to viewport, this is fine.
                // Subtract overlay height (estimated or measured) to place on top

                // Better approach: Let's assume the overlay wrapper is absolute 0,0 in a Stack covering the window.
                const containerOffset = 222;
                const overlayHeight = overlay.offsetHeight || 60; // Estimate or measure
                const top = Math.max(0, rect.top - overlayHeight - 10) + containerOffset;
                const left = rect.left;

                overlay.style.top = `${top}px`;
                overlay.style.left = `${left}px`;
            }

        } else {
            state.hasSelection = false;
            state.selectionRect = null;

            // Hide overlay
            if (window._pythraOverlay) {
                window._pythraOverlay.style.display = 'none';
            }
        }

        // Send this entire state object to Python in a single call.
        // We reuse handleInput, but the value is now a JSON string of the state object.
        // console.log("cusorState: ", state);
        handleInput(this.options.onStateChangeCallback, JSON.stringify(state));
        syncExternalToolbarState(state);
    }

    injectStyles() {
        const style = document.createElement('style');
        style.id = 'pythra-editor-styles';
        style.textContent = `
            :root{--pe-accent-color:#007aff;--pe-accent-hover:#005bb5;--pe-border-color:#dee2e6;--pe-border-radius:6px;--pe-border-width:1px;--pe-focus-ring-color:rgba(0,122,255,0.25);--pe-focus-ring-width:3px;--pe-toolbar-bg:#f1f3f5;--pe-toolbar-hover:#e9ecef;--pe-toolbar-active:#007aff;--pe-toolbar-icon:#212529;--pe-content-bg:#ffffff;--pe-content-text:#212529;--pe-content-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;--pe-content-font-size:16px;--pe-content-line-height:1.7;--pe-content-padding:1.5rem;--pe-content-placeholder:#6c757d;--pe-grid-dot-color:#D3D3D3;--pe-grid-dot-size:1px;--pe-grid-dot-spacing:20px;--pe-grid-background-color:transparent;}
            .pythra-editor-wrapper{box-sizing:border-box;display:flex;flex-direction:column;background:var(--pe-content-bg);border:var(--pe-border-width) solid var(--pe-border-color);border-radius:var(--pe-border-radius);box-shadow:0 4px 12px rgba(0,0,0,0.05);}
            .pythra-editor-wrapper [contenteditable]{color:var(--pe-content-text);font-family:var(--pe-content-font);font-size:var(--pe-content-font-size);line-height:var(--pe-content-line-height);padding:var(--pe-content-padding);flex-grow:1;min-height:150px;border-top:1px solid var(--pe-border-color);outline:none;overflow-y:auto;}
            .pythra-editor-wrapper [contenteditable]:focus{border-color:var(--pe-accent-color) !important;box-shadow:0 0 0 var(--pe-focus-ring-width) var(--pe-focus-ring-color)}
            .pythra-editor-wrapper [contenteditable]:empty:before{content:"Start writing...";color:var(--pe-content-placeholder);font-style:italic}
            .pythra-editor-wrapper .pythra-toggle-button{flex-shrink:0;width:100%;padding:0.75rem;font-size:1rem;font-weight:600;color:white;background-color:var(--pe-accent-color);border:none;border-radius:var(--pe-border-radius) var(--pe-border-radius) 0 0;cursor:pointer;transition:background-color 0.2s ease;}
            .pythra-editor-wrapper .pythra-toggle-button:hover{background-color:var(--pe-accent-hover)}
            .control-panel{flex-shrink:0;background:var(--pe-toolbar-bg);padding:1rem;display:flex;flex-direction:column;gap:1rem;transition:all 0.3s ease-in-out;max-height:1000px;opacity:1;overflow:hidden;}
            .control-panel.hidden{max-height:0;padding-top:0;padding-bottom:0;opacity:0;}
            .control-group{display:flex;flex-wrap:wrap;gap:0.5rem;align-items:center}
            .control-panel button,.control-panel select,.control-panel input[type="color"]{color:var(--pe-toolbar-icon);font-family:var(--pe-content-font);font-size:0.9rem;padding:0.5rem 0.75rem;background:var(--pe-content-bg);border:1px solid var(--pe-border-color);border-radius:var(--pe-border-radius);cursor:pointer;transition:all 0.2s ease;}
            .control-panel button:hover,.control-panel select:hover{background:var(--pe-toolbar-hover)}
            .control-panel button.active{background-color:var(--pe-toolbar-active);color:white;border-color:var(--pe-accent-hover)}
            .control-panel select:focus{border-color:var(--pe-accent-color);box-shadow:0 0 0 var(--pe-focus-ring-width) var(--pe-focus-ring-color);background-color:var(--pe-content-bg);}
            .pythra-image-resizer-wrapper{position:absolute;border:2px solid var(--pe-accent-color);pointer-events:none;}
            .pythra-resize-handle{position:absolute;width:10px;height:10px;background-color:var(--pe-accent-color);border:1px solid white;border-radius:50%;pointer-events:auto;}
            .pythra-editor-wrapper [contenteditable].grid-background{background-image:radial-gradient(var(--pe-grid-dot-color) var(--pe-grid-dot-size), transparent 0);background-size:var(--pe-grid-dot-spacing) var(--pe-grid-dot-spacing);background-color:var(--pe-grid-background-color)}
        `;
        document.head.appendChild(style);
    }

    updateButtonStates() {
        ['bold', 'italic', 'underline', 'strikeThrough'].forEach(command => {
            const button = document.getElementById(`btn-${command}_${this.options.instanceId}`);
            if (!button) return;
            try {
                button.classList.toggle('active', document.queryCommandState(command));
            } catch (e) { }
        });
    }

    execCommand(command, value = null) {
        if (!command || !this.editorElement) return;
        this.editorElement.focus();
        try {
            var result = document.execCommand(command, false, value);
            console.log(`JS execCommand: ${command}, Value: ${value}, Success: ${result}`);
        } catch (err) {
            console.error(`Error executing command '${command}':`, err);
        }
        this.updateButtonStates();
    }

    setContent(html) { if (this.editorElement) this.editorElement.innerHTML = html; }
    getContent() { return this.editorElement ? this.editorElement.innerHTML : ''; }
    focus() { if (this.editorElement) this.editorElement.focus(); }

    destroy() {
        console.log(`ðŸ”¥ Destroying PythraMarkdownEditor instance: ${this.options.instanceId}`);
        if (this.editorElement && this._changeHandler) {
            this.editorElement.removeEventListener('input', this._changeHandler);
        }
        if (this.editorElement && this._feedbackHandler) {
            ['keyup', 'mouseup', 'focus', 'click'].forEach(eventType => {
                this.editorElement.removeEventListener(eventType, this._feedbackHandler);
            });
        }
        if (this.imageResizer) {
            this.imageResizer.destroy();
        }
        clearTimeout(this._changeTimer);
    }
}

// --- NEW: JS-Controlled Overlay Logic ---

class PythraSelectionOverlay {
    constructor(elementOrId, options = {}) {
        if (typeof elementOrId === 'string') {
            this.container = document.getElementById(elementOrId);
        } else {
            this.container = elementOrId;
        }

        if (this.container) {
            // Save to global scope for the editor to access
            window._pythraOverlay = this.container;

            // Initial style: hidden and absolute
            this.container.style.position = 'absolute';
            this.container.style.display = 'none';
            this.container.style.zIndex = '1000'; // Ensure it's on top
            this.container.style.transition = 'opacity 0.2s ease, top 0.1s ease, left 0.1s ease';
            this.container.style.pointerEvents = 'auto'; // Make sure clicks work
        }
    }
}

window.PythraSelectionOverlay = PythraSelectionOverlay;

window.PythraMarkdownEditor = PythraMarkdownEditor;

document.addEventListener("DOMContentLoaded", () => {
    try {
        document.execCommand("styleWithCSS", false, true);
    } catch (e) {
        console.warn("styleWithCSS is not supported by this browser.");
    }
});

// --- NEW: Global function to restore the saved selection ---
function restoreEditorSelection() {
    const savedRange = window._pythraSavedSelection;
    if (savedRange) {
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(savedRange);
        console.log('ðŸ”„ Selection Restored.');
    } else {
        console.warn("No valid selection was saved to restore.");
    }
}

window.restoreEditorSelection = restoreEditorSelection;

// --- NEW: Global function to hide the overlay ---
window.hidePythraSelectionOverlay = function () {
    if (window._pythraOverlay) {
        window._pythraOverlay.style.display = 'none';
        console.log('Overlay hidden');
    }
};

class PythraImageResizer {
    constructor(editorElement) { this.editor = editorElement; this.selectedImage = null; this.wrapper = null; this.handleClick = this.handleClick.bind(this); this.handleMouseDown = this.handleMouseDown.bind(this); this.handleMouseMove = this.handleMouseMove.bind(this); this.handleMouseUp = this.handleMouseUp.bind(this); this.editor.addEventListener('click', this.handleClick); }
    handleClick(e) { const target = e.target; if (target.tagName === 'IMG') { if (this.selectedImage !== target) { this.selectImage(target); } } else if (this.selectedImage) { this.deselectImage(); } }
    selectImage(img) { this.deselectImage(); this.selectedImage = img; this.wrapper = document.createElement('div'); this.wrapper.className = 'pythra-image-resizer-wrapper'; this.editor.parentNode.style.position = this.editor.parentNode.style.position || 'relative'; this.editor.parentNode.appendChild(this.wrapper); this.positionWrapper(); const handlePositions = ['top-left', 'top-right', 'bottom-left', 'bottom-right']; handlePositions.forEach(pos => { const handle = document.createElement('div'); handle.className = `pythra-resize-handle ${pos}`; handle.dataset.position = pos; this.wrapper.appendChild(handle); handle.addEventListener('mousedown', this.handleMouseDown); }); }
    deselectImage() { if (this.wrapper) { this.wrapper.remove(); this.wrapper = null; } this.selectedImage = null; }
    positionWrapper() { if (!this.selectedImage || !this.wrapper) return; const editorParent = this.editor.parentNode; const imgRect = this.selectedImage.getBoundingClientRect(); const parentRect = editorParent.getBoundingClientRect(); this.wrapper.style.top = `${imgRect.top - parentRect.top}px`; this.wrapper.style.left = `${imgRect.left - parentRect.left}px`; this.wrapper.style.width = `${imgRect.width}px`; this.wrapper.style.height = `${imgRect.height}px`; }
    handleMouseDown(e) { e.preventDefault(); e.stopPropagation(); this.startRect = this.selectedImage.getBoundingClientRect(); this.startPos = { x: e.clientX, y: e.clientY }; this.handlePosition = e.target.dataset.position; document.addEventListener('mousemove', this.handleMouseMove); document.addEventListener('mouseup', this.handleMouseUp); }
    handleMouseMove(e) { if (!this.startRect) return; const dx = e.clientX - this.startPos.x; let newWidth = this.startRect.width; if (this.handlePosition.includes('right')) { newWidth += dx; } else if (this.handlePosition.includes('left')) { newWidth -= dx; } this.selectedImage.style.width = `${Math.max(20, newWidth)}px`; this.selectedImage.style.height = 'auto'; this.positionWrapper(); }
    handleMouseUp() { document.removeEventListener('mousemove', this.handleMouseMove); document.removeEventListener('mouseup', this.handleMouseUp); this.startRect = null; this.editor.dispatchEvent(new Event('input', { bubbles: true, cancelable: true })); }
    destroy() { this.editor.removeEventListener('click', this.handleClick); this.deselectImage(); }
}

// Add this new function at the very end of your editor.js file.

/**
 * Updates the visual state of external toolbar buttons based on the editor's cursor state.
 * It looks for buttons with specific, predictable class names.
 * @param {object} cursorState - The state object received from Python.
 */
function syncExternalToolbarState(cursorState) {
    if (!cursorState) return;

    console.log("sync state:", cursorState)

    // A mapping from the state property to the CSS class to look for.
    const stateToClassMap = {
        isBold: 'pythra-toolbar-bold',
        isItalic: 'pythra-toolbar-italic',
        isUnderline: 'pythra-toolbar-underline',
        isStrikeThrough: 'pythra-toolbar-strikethrough',
        isUnorderedList: 'pythra-toolbar-ul',
        isOrderedList: 'pythra-toolbar-ol'
    };

    for (const key in stateToClassMap) {
        const className = stateToClassMap[key];
        const isActive = cursorState[key];

        // Find all buttons that have this class
        const buttons = document.querySelectorAll(`.${className}`);

        buttons.forEach(button => {
            // Use classList.toggle for a clean and efficient update.
            // The second argument forces 'add' if isActive is true, and 'remove' if false.
            button.classList.toggle('active', isActive);
        });
    }

    // --- 2. THE CORRECTED LOGIC for the font color button ---

    // Find the icon using its new, stable class name.
    const colorButtonIcon = document.querySelector('.pythra-toolbar-font-color-btn');

    if (colorButtonIcon) {
        // Get the color from the cursor state.
        const newColor = cursorState.fontColor;

        if (newColor && newColor !== "inherit" && newColor !== "rgb(0, 0, 0)" && newColor !== "rgba(0, 0, 0, 0)") {
            // --- USE setProperty WITH '!important' ---
            colorButtonIcon.style.setProperty('color', newColor, 'important');
            console.log(newColor)
        } else {
            // If no specific color, remove our inline override to revert to CSS class default.
            colorButtonIcon.style.removeProperty('color');
        }
    }
    // You can add more complex logic for dropdowns here if needed
    // For example, finding a dropdown and setting its value based on cursorState.fontName
}

window.syncExternalToolbarState = syncExternalToolbarState;

/**
 * Replace the current selection (or saved selection) with the provided HTML.
 * - If there's an active selection, it will be replaced.
 * - If there's no active selection but a saved selection exists (`window._pythraSavedSelection`), that will be used.
 * - If no selection can be found, the HTML will be appended to the first `.editor-inner-container` found.
 * 
 * SMART INLINE HANDLING:
 * - If replacing text within an inline context (e.g., within a <p>), and the replacement
 *   contains only inline elements, it will be inserted cleanly without breaking the block.
 * - If the replacement contains block elements (e.g., <h1>, <div>), they are preserved
 *   and inserted naturally, potentially splitting the containing block if necessary.
 * 
 * After inserting, an `input` event is dispatched on the affected editor to notify change handlers.
 * @param {string} newHtml - The HTML string to insert in place of the selection.
 */
function replaceEditorSelection(newHtml) {
    if (!newHtml) return;
    restoreEditorSelection();

    let selection = window.getSelection();
    let range = null;

    if (selection && selection.rangeCount > 0) {
        range = selection.getRangeAt(0);
    } else if (window._pythraSavedSelection) {
        try {
            range = window._pythraSavedSelection.cloneRange ? window._pythraSavedSelection.cloneRange() : window._pythraSavedSelection;
        } catch (e) {
            range = window._pythraSavedSelection;
        }
    }

    // Helper to dispatch input on closest editor container
    function dispatchInputFromNode(node) {
        if (!node) return;
        const editor = node.nodeType === 3 ? node.parentElement.closest('.editor-inner-container') : (node.closest ? node.closest('.editor-inner-container') : null);
        if (editor) editor.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
    }

    // Helper to check if HTML contains block-level elements
    function containsBlockElements(html) {
        const blockTags = /^<(div|p|h[1-6]|ul|ol|li|blockquote|pre|table|form|fieldset|section|article|aside|header|footer|main|nav)\b/i;
        return blockTags.test(html.trim());
    }

    if (!range) {
        // Fallback: append to first editor
        const editor = document.querySelector('.editor-inner-container[contenteditable="true"]');
        if (editor) {
            try {
                const frag = document.createRange().createContextualFragment(newHtml);
                editor.appendChild(frag);
                dispatchInputFromNode(editor);
            } catch (e) {
                console.error('replaceEditorSelection fallback append error:', e);
            }
        } else {
            console.warn('replaceEditorSelection: no selection and no editor found to insert into.');
        }
        return;
    }

    try {
        // Normalize selection to be editable: ensure we have a live selection object
        selection = window.getSelection();
        if (selection.rangeCount > 0) selection.removeAllRanges();

        // Delete current contents of the range
        range.deleteContents();

        // Determine insertion strategy based on context
        const isInlineOnlyReplacement = !containsBlockElements(newHtml);
        const isWithinInlineContainer = range.commonAncestorContainer.nodeType === 3 ||
            (range.commonAncestorContainer.nodeType === 1 && 
             /^(p|span|a|em|strong|b|i|u|s|mark|code|small|sub|sup|kbd|var|samp|q|dfn|abbr|cite)$/i.test(range.commonAncestorContainer.tagName));

        let lastInsertedNode = null;

        if (isInlineOnlyReplacement && isWithinInlineContainer) {
            // Smart inline insertion: use insertAdjacentHTML to avoid breaking the block
            const temp = document.createElement('div');
            temp.innerHTML = newHtml;
            
            // Insert each child node at the range position
            const nodes = Array.from(temp.childNodes);
            nodes.forEach((node, idx) => {
                const cloned = node.cloneNode(true);
                range.insertNode(cloned);
                lastInsertedNode = cloned;
                // Move range forward so next node inserts after this one
                range.setStartAfter(cloned);
                range.collapse(true);
            });
        } else {
            // Standard insertion for block content or when not in inline context
            const temp = document.createElement('div');
            temp.innerHTML = newHtml;
            const frag = document.createDocumentFragment();
            while (temp.firstChild) {
                lastInsertedNode = temp.firstChild;
                frag.appendChild(temp.firstChild);
            }
            range.insertNode(frag);
        }

        // Move caret after inserted content
        const sel = window.getSelection();
        sel.removeAllRanges();
        const newRange = document.createRange();

        if (lastInsertedNode) {
            try {
                newRange.setStartAfter(lastInsertedNode);
                newRange.collapse(true);
            } catch (e) {
                // Fallback: collapse to end of the original range
                newRange.setStart(range.endContainer, range.endOffset);
                newRange.collapse(true);
            }
        } else {
            newRange.setStart(range.endContainer, range.endOffset);
            newRange.collapse(true);
        }
        sel.addRange(newRange);

        // Notify editor about input change
        dispatchInputFromNode(newRange.startContainer || newRange.commonAncestorContainer);
    } catch (err) {
        console.error('replaceEditorSelection error:', err);
    }
}

window.replaceEditorSelection = replaceEditorSelection;
} catch (e) { console.error('Error loading plugin pythra-markdown-editor - editor.js:', e); }
                    
                    // Then, RUN the initialization commands that were generated
                    
                    // Step 0: Convert Python's array-of-arrays to JS's array-of-objects
                    const pointsForGenerator_fw_id_30 = [[0,0],[58,0],[58,22],[100,22],[100,78],[78,78],[78,100],[48,100],[48,78],[0,78]].map(p => ({x: p[0], y: p[1]}));
                    
                    // Step 1: Call generateRoundedPath with the points and radius
                    const initialPathString_fw_id_30 = window.generateRoundedPath(pointsForGenerator_fw_id_30, 8);
                    
                    // Step 2: Feed the generated path into ResponsiveClipPath
                    window._pythra_instances['fw_id_30'] = new window.ResponsiveClipPath(
                        'fw_id_30', 
                        initialPathString_fw_id_30, 
                        100, 
                        100, 
                        { uniformArc: true, decimalPlaces: 2 }
                    );
                
                    // Step 0: Convert Python's array-of-arrays to JS's array-of-objects
                    const pointsForGenerator_fw_id_55 = [[0,0],[58,0],[58,22],[100,22],[100,78],[78,78],[78,100],[48,100],[48,78],[0,78]].map(p => ({x: p[0], y: p[1]}));
                    
                    // Step 1: Call generateRoundedPath with the points and radius
                    const initialPathString_fw_id_55 = window.generateRoundedPath(pointsForGenerator_fw_id_55, 8);
                    
                    // Step 2: Feed the generated path into ResponsiveClipPath
                    window._pythra_instances['fw_id_55'] = new window.ResponsiveClipPath(
                        'fw_id_55', 
                        initialPathString_fw_id_55, 
                        100, 
                        100, 
                        { uniformArc: true, decimalPlaces: 2 }
                    );
                
                    // Step 0: Convert Python's array-of-arrays to JS's array-of-objects
                    const pointsForGenerator_fw_id_80 = [[0,0],[58,0],[58,22],[100,22],[100,78],[78,78],[78,100],[48,100],[48,78],[0,78]].map(p => ({x: p[0], y: p[1]}));
                    
                    // Step 1: Call generateRoundedPath with the points and radius
                    const initialPathString_fw_id_80 = window.generateRoundedPath(pointsForGenerator_fw_id_80, 8);
                    
                    // Step 2: Feed the generated path into ResponsiveClipPath
                    window._pythra_instances['fw_id_80'] = new window.ResponsiveClipPath(
                        'fw_id_80', 
                        initialPathString_fw_id_80, 
                        100, 
                        100, 
                        { uniformArc: true, decimalPlaces: 2 }
                    );
                

                } catch (e) {
                    console.error("Error running Pythra initializers:", e);
                }
            });
        </script>
        
</body>
</html>